<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring System Playground - RSS/TDMS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: #f5f7fa;
            border-bottom: 2px solid #e1e8ed;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e8ecef;
        }

        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 5px;
        }

        .critical { background: #ff4757; color: white; }
        .degraded { background: #ffa502; color: white; }
        .warning { background: #ffd93d; color: #333; }
        .info { background: #6c5ce7; color: white; }
        .ok { background: #26de81; color: white; }
        .soft { background: #95afc0; color: white; }
        .hard { background: #273c75; color: white; }

        .device {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }

        .device:hover {
            background: #e9ecef;
            border-left-color: #667eea;
        }

        .device.critical { border-left-color: #ff4757; }
        .device.degraded { border-left-color: #ffa502; }
        .device.warning { border-left-color: #ffd93d; }
        .device.ok { border-left-color: #26de81; }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .simulation-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alarm-log {
            max-height: 400px;
            overflow-y: auto;
            background: #1e272e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .alarm-entry {
            padding: 8px;
            border-bottom: 1px solid #2d3436;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .flow-step {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 150px;
            margin: 10px;
        }

        .flow-arrow {
            font-size: 2em;
            color: #667eea;
            margin: 0 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        th {
            background: #f5f7fa;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .notification-channel {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .notification-channel.active {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .map-container {
            position: relative;
            height: 400px;
            background: #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .map-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
            animation: pulse 2s infinite;
        }

        .map-marker:hover {
            transform: scale(1.2);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .counter {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 8px;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }

        .test-pass {
            background: #d4edda;
            color: #155724;
        }

        .test-fail {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Monitoring System Playground</h1>
            <p class="subtitle">Interactive RSS/TDMS Alarm Management Training Tool</p>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="overview">üìä Overview</div>
            <div class="tab" data-tab="map">üó∫Ô∏è Site Map</div>
            <div class="tab" data-tab="devices">üñ•Ô∏è Devices</div>
            <div class="tab" data-tab="alarms">üö® Alarms</div>
            <div class="tab" data-tab="simulation">‚öôÔ∏è Simulation</div>
            <div class="tab" data-tab="tests">‚úÖ Tests</div>
        </div>

        <div class="content">
            <!-- Overview Tab -->
            <div class="tab-content active" data-content="overview">
                <h2>System Architecture & Alarm Flow</h2>
                <p class="info-box">
                    This playground demonstrates the complete alarm lifecycle from detection through classification to notification,
                    based on the Icinga2 monitoring system with Business Process filtering.
                </p>

                <div class="flow-diagram">
                    <div class="flow-step">
                        <h3>üîç Detection</h3>
                        <p>Icinga2 Check</p>
                        <span class="status-badge soft">Soft State</span>
                    </div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">
                        <h3>‚úì Confirmation</h3>
                        <p>3-Minute Validation</p>
                        <span class="status-badge hard">Hard State</span>
                    </div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">
                        <h3>üéØ Classification</h3>
                        <p>Business Process</p>
                        <span class="status-badge critical">Critical</span>
                    </div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">
                        <h3>üì¢ Notification</h3>
                        <p>PagerDuty/Email</p>
                        <span class="status-badge ok">Sent</span>
                    </div>
                </div>

                <h3>Alarm Classification Matrix</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Impact</th>
                            <th>Action Required</th>
                            <th>Notification</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="status-badge critical">Critical</span></td>
                            <td>Revenue Loss</td>
                            <td>Immediate 24/7</td>
                            <td>PagerDuty Call + Email + Grafana</td>
                        </tr>
                        <tr>
                            <td><span class="status-badge degraded">Degraded</span></td>
                            <td>Data Loss (No Revenue Impact)</td>
                            <td>Business Hours</td>
                            <td>Email + PagerDuty (Business Hours) + Grafana</td>
                        </tr>
                        <tr>
                            <td><span class="status-badge warning">Warning</span></td>
                            <td>System Anomaly</td>
                            <td>Business Hours</td>
                            <td>Email + Grafana</td>
                        </tr>
                        <tr>
                            <td><span class="status-badge info">Info</span></td>
                            <td>Potential Anomaly</td>
                            <td>Investigation Required</td>
                            <td>Email + Grafana</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Quick Stats</h3>
                <div class="grid">
                    <div class="card">
                        <h4>RSS Devices</h4>
                        <p style="font-size: 2em; color: #667eea; font-weight: bold;" id="rss-count">42</p>
                        <p>TSMC, TSC, UPS, VDC/VR, Generators</p>
                    </div>
                    <div class="card">
                        <h4>TDMS Devices</h4>
                        <p style="font-size: 2em; color: #764ba2; font-weight: bold;" id="tdms-count">38</p>
                        <p>Servers, Databases, Virtual Infrastructure</p>
                    </div>
                    <div class="card">
                        <h4>Active Alarms</h4>
                        <p style="font-size: 2em; color: #ff4757; font-weight: bold;" id="alarm-count">0</p>
                        <p>Currently Monitoring</p>
                    </div>
                    <div class="card">
                        <h4>System Status</h4>
                        <p style="font-size: 2em; color: #26de81; font-weight: bold;">100%</p>
                        <p>Overall Health</p>
                    </div>
                </div>
            </div>

            <!-- Map Tab -->
            <div class="tab-content" data-content="map">
                <h2>Site Topology Map</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color critical"></div>
                        <span>Critical Status</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color degraded"></div>
                        <span>Degraded Status</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color warning"></div>
                        <span>Warning Status</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color ok"></div>
                        <span>OK Status</span>
                    </div>
                </div>
                <div class="map-container" id="site-map">
                    <!-- Markers will be dynamically added -->
                </div>
                <div id="device-info" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; min-height: 100px;">
                    <p style="color: #6c757d;">Click on a device marker to see details</p>
                </div>
            </div>

            <!-- Devices Tab -->
            <div class="tab-content" data-content="devices">
                <h2>Monitored Devices <span class="counter" id="device-total">0</span></h2>
                
                <div style="margin-bottom: 20px;">
                    <button onclick="filterDevices('all')">All</button>
                    <button onclick="filterDevices('RSS')">RSS</button>
                    <button onclick="filterDevices('TDMS')">TDMS</button>
                    <button onclick="filterDevices('critical')">Critical Only</button>
                </div>

                <div id="device-list"></div>
            </div>

            <!-- Alarms Tab -->
            <div class="tab-content" data-content="alarms">
                <h2>Active Alarms <span class="counter" id="active-alarms">0</span></h2>
                
                <div class="grid">
                    <div class="card">
                        <h4>Notification Channels</h4>
                        <div class="notification-channel" id="notify-pagerduty">
                            <span style="font-size: 1.5em; margin-right: 10px;">üìû</span>
                            <div>
                                <strong>PagerDuty</strong>
                                <p style="font-size: 0.9em; color: #6c757d;">Voice Call</p>
                            </div>
                        </div>
                        <div class="notification-channel" id="notify-email">
                            <span style="font-size: 1.5em; margin-right: 10px;">üìß</span>
                            <div>
                                <strong>Email</strong>
                                <p style="font-size: 0.9em; color: #6c757d;">Immediate</p>
                            </div>
                        </div>
                        <div class="notification-channel" id="notify-grafana">
                            <span style="font-size: 1.5em; margin-right: 10px;">üìä</span>
                            <div>
                                <strong>Grafana</strong>
                                <p style="font-size: 0.9em; color: #6c757d;">Dashboard</p>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h4>Alarm Statistics</h4>
                        <div style="margin: 10px 0;">
                            <span class="status-badge critical">Critical</span>
                            <span class="counter" id="stat-critical">0</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <span class="status-badge degraded">Degraded</span>
                            <span class="counter" id="stat-degraded">0</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <span class="status-badge warning">Warning</span>
                            <span class="counter" id="stat-warning">0</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <span class="status-badge info">Info</span>
                            <span class="counter" id="stat-info">0</span>
                        </div>
                    </div>
                </div>

                <h3>Alarm Log</h3>
                <div class="alarm-log" id="alarm-log">
                    <div class="alarm-entry">[SYSTEM] Monitoring system initialized...</div>
                </div>
            </div>

            <!-- Simulation Tab -->
            <div class="tab-content" data-content="simulation">
                <h2>‚öôÔ∏è Interactive Simulation</h2>
                <p class="info-box">
                    Trigger various alarm scenarios to see how the system responds. Watch the alarm flow from 
                    detection (Soft State) ‚Üí confirmation (Hard State) ‚Üí classification ‚Üí notification.
                </p>

                <div class="simulation-controls">
                    <h3>Scenario Triggers</h3>
                    <div class="grid">
                        <div class="card">
                            <h4>üî¥ Critical Scenarios</h4>
                            <button onclick="simulateAlarm('TSMC-001', 'Ping', 'critical', 'TSMC device unreachable')">TSMC Ping Failure</button>
                            <button onclick="simulateAlarm('DB-001', 'all', 'critical', 'Database server down')">Database Down</button>
                            <button onclick="simulateAlarm('UPS-001', 'UPS on Battery', 'critical', 'UPS running on battery')">UPS On Battery</button>
                        </div>
                        <div class="card">
                            <h4>üü† Degraded Scenarios</h4>
                            <button onclick="simulateAlarm('TSC-001', 'ALC-SensorFunctionality', 'degraded', 'Sensor functionality degraded')">Sensor Degraded</button>
                            <button onclick="simulateAlarm('GEN-001', 'Generator Fuel', 'degraded', 'Low fuel level detected')">Generator Low Fuel</button>
                            <button onclick="simulateVDCPairFailure()">VDC Pair Failure</button>
                        </div>
                        <div class="card">
                            <h4>üü° Warning Scenarios</h4>
                            <button onclick="simulateAlarm('TSMC-002', 'ToolsStatistics', 'warning', 'Statistics anomaly detected')">Tools Statistics Warning</button>
                            <button onclick="simulateAlarm('UPS-002', 'Battery-Status', 'warning', 'Battery health degrading')">UPS Battery Warning</button>
                        </div>
                        <div class="card">
                            <h4>üîµ Info Scenarios</h4>
                            <button onclick="simulateAlarm('TSMC-003', 'IllegalComm', 'info', 'Unauthorized communication detected')">Illegal Communication</button>
                            <button onclick="simulateAlarm('TSC-002', 'ALC-ToolsConfiguration', 'info', 'Configuration change detected')">Config Change</button>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">‚è±Ô∏è State Transition Simulator</h3>
                    <div class="card">
                        <p>Watch an alarm transition from Soft ‚Üí Hard state over 3 minutes (accelerated to 5 seconds)</p>
                        <button onclick="simulateStateTransition()">Start State Transition Demo</button>
                        <div id="state-transition" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                            <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                                <span>Check 1:</span>
                                <span id="check1" class="status-badge soft">Soft</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                                <span>Check 2:</span>
                                <span id="check2" class="status-badge soft">Soft</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                                <span>Check 3:</span>
                                <span id="check3" class="status-badge soft">Soft</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                                <span>Final State:</span>
                                <span id="finalState" class="status-badge">Pending</span>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">üîÑ Quick Actions</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="clearAllAlarms()">Clear All Alarms</button>
                        <button onclick="resetSimulation()">Reset Simulation</button>
                        <button onclick="generateRandomScenario()">Random Scenario</button>
                    </div>
                </div>
            </div>

            <!-- Tests Tab -->
            <div class="tab-content" data-content="tests">
                <h2>‚úÖ System Validation Tests</h2>
                <p class="info-box">
                    Automated tests to verify alarm classification, notification routing, and business logic.
                </p>
                
                <button onclick="runAllTests()" style="margin-bottom: 20px;">Run All Tests</button>
                
                <div id="test-results"></div>
            </div>
        </div>
    </div>

    <script>
        // Data Models
        const devices = [
            // RSS Devices
            { id: 'TSMC-001', name: 'TSMC Site A', type: 'RSS', category: 'TSMC', status: 'ok', x: 20, y: 30 },
            { id: 'TSMC-002', name: 'TSMC Site B', type: 'RSS', category: 'TSMC', status: 'ok', x: 80, y: 25 },
            { id: 'TSC-001', name: 'TSC Lane 1', type: 'RSS', category: 'TSC', status: 'ok', x: 35, y: 50 },
            { id: 'TSC-002', name: 'TSC Lane 2', type: 'RSS', category: 'TSC', status: 'ok', x: 65, y: 55 },
            { id: 'UPS-001', name: 'UPS Primary', type: 'RSS', category: 'UPS', status: 'ok', x: 25, y: 75 },
            { id: 'UPS-002', name: 'UPS Secondary', type: 'RSS', category: 'UPS', status: 'ok', x: 75, y: 70 },
            { id: 'VDC-001', name: 'VDC SU1', type: 'RSS', category: 'VDC', status: 'ok', x: 40, y: 40 },
            { id: 'VDC-002', name: 'VDC SU2', type: 'RSS', category: 'VDC', status: 'ok', x: 60, y: 45 },
            { id: 'GEN-001', name: 'Generator 1', type: 'RSS', category: 'Generator', status: 'ok', x: 15, y: 85 },
            
            // TDMS Devices
            { id: 'DB-001', name: 'Database Primary', type: 'TDMS', category: 'DB', status: 'ok', x: 50, y: 20 },
            { id: 'APP-001', name: 'Application Server', type: 'TDMS', category: 'APP', status: 'ok', x: 45, y: 65 },
            { id: 'ESXI-001', name: 'ESXi Host 1', type: 'TDMS', category: 'ESXi', status: 'ok', x: 70, y: 35 },
            { id: 'VC-001', name: 'vCenter', type: 'TDMS', category: 'VC', status: 'ok', x: 55, y: 80 },
        ];

        const alarmClassification = {
            critical: {
                impact: 'Revenue Loss',
                action: 'Immediate 24/7',
                notifications: ['pagerduty', 'email', 'grafana']
            },
            degraded: {
                impact: 'Data Loss (No Revenue Impact)',
                action: 'Business Hours',
                notifications: ['email', 'grafana', 'pagerduty-business']
            },
            warning: {
                impact: 'System Anomaly',
                action: 'Business Hours',
                notifications: ['email', 'grafana']
            },
            info: {
                impact: 'Potential Anomaly',
                action: 'Investigation Required',
                notifications: ['email', 'grafana']
            }
        };

        let activeAlarms = [];
        let alarmHistory = [];

        // Initialize
        function init() {
            setupTabs();
            renderDevices();
            renderMap();
            updateStats();
        }

        // Tab Management
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.querySelector(`[data-content="${targetTab}"]`).classList.add('active');
                });
            });
        }

        // Render Devices List
        function renderDevices() {
            const list = document.getElementById('device-list');
            list.innerHTML = devices.map(device => `
                <div class="device ${device.status}" data-type="${device.type}" data-category="${device.category}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${device.name}</strong> (${device.id})
                            <br>
                            <small>${device.type} / ${device.category}</small>
                        </div>
                        <span class="status-badge ${device.status}">${device.status.toUpperCase()}</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('device-total').textContent = devices.length;
        }

        // Filter Devices
        function filterDevices(filter) {
            const deviceElements = document.querySelectorAll('.device');
            let visibleCount = 0;
            
            deviceElements.forEach(device => {
                const type = device.dataset.type;
                const status = device.classList.contains('critical') ? 'critical' : 'other';
                
                let show = false;
                if (filter === 'all') show = true;
                else if (filter === 'RSS' && type === 'RSS') show = true;
                else if (filter === 'TDMS' && type === 'TDMS') show = true;
                else if (filter === 'critical' && status === 'critical') show = true;
                
                device.style.display = show ? 'block' : 'none';
                if (show) visibleCount++;
            });
            
            document.getElementById('device-total').textContent = visibleCount;
        }

        // Render Map
        function renderMap() {
            const map = document.getElementById('site-map');
            map.innerHTML = devices.map(device => {
                const left = device.x;
                const top = device.y;
                return `
                    <div class="map-marker ${device.status}" 
                         style="left: ${left}%; top: ${top}%;"
                         onclick="showDeviceInfo('${device.id}')"
                         title="${device.name}">
                        ${device.category[0]}
                    </div>
                `;
            }).join('');
        }

        // Show Device Info
        function showDeviceInfo(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            const info = document.getElementById('device-info');
            const deviceAlarms = activeAlarms.filter(a => a.deviceId === deviceId);
            
            info.innerHTML = `
                <h3>${device.name}</h3>
                <p><strong>ID:</strong> ${device.id}</p>
                <p><strong>Type:</strong> ${device.type} - ${device.category}</p>
                <p><strong>Status:</strong> <span class="status-badge ${device.status}">${device.status.toUpperCase()}</span></p>
                ${deviceAlarms.length > 0 ? `
                    <h4>Active Alarms:</h4>
                    ${deviceAlarms.map(a => `
                        <div style="padding: 10px; margin: 5px 0; background: white; border-radius: 4px; border-left: 4px solid var(--alarm-color);">
                            <span class="status-badge ${a.severity}">${a.severity.toUpperCase()}</span>
                            ${a.service} - ${a.description}
                        </div>
                    `).join('')}
                ` : '<p>No active alarms</p>'}
            `;
        }

        // Simulate Alarm
        function simulateAlarm(deviceId, service, severity, description) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            logAlarm(`[DETECTION] ${device.name} - ${service} - ${description}`, 'soft');
            
            setTimeout(() => {
                logAlarm(`[CONFIRMATION] State transition: Soft ‚Üí Hard`, 'hard');
                
                const alarm = {
                    id: `ALM-${Date.now()}`,
                    deviceId,
                    deviceName: device.name,
                    service,
                    severity,
                    description,
                    timestamp: new Date(),
                    state: 'hard',
                    notifications: []
                };
                
                activeAlarms.push(alarm);
                alarmHistory.push(alarm);
                
                // Update device status
                device.status = severity;
                
                // Classify and notify
                classifyAndNotify(alarm);
                
                // Update UI
                updateStats();
                renderDevices();
                renderMap();
                
            }, 2000); // Simulate 3-minute confirmation as 2 seconds
        }

        // Classify and Notify
        function classifyAndNotify(alarm) {
            const classification = alarmClassification[alarm.severity];
            
            logAlarm(`[CLASSIFICATION] Severity: ${alarm.severity.toUpperCase()} - Impact: ${classification.impact}`, alarm.severity);
            
            // Trigger notifications
            classification.notifications.forEach(channel => {
                if (channel === 'pagerduty') {
                    activateNotification('pagerduty');
                    logAlarm(`[NOTIFICATION] PagerDuty call initiated - Voice alert to on-call technician`, 'critical');
                    alarm.notifications.push('PagerDuty Call');
                } else if (channel === 'email') {
                    activateNotification('email');
                    logAlarm(`[NOTIFICATION] Email sent with full alarm details`, 'info');
                    alarm.notifications.push('Email');
                } else if (channel === 'grafana') {
                    activateNotification('grafana');
                    logAlarm(`[NOTIFICATION] Grafana dashboard updated`, 'info');
                    alarm.notifications.push('Grafana');
                } else if (channel === 'pagerduty-business') {
                    const hour = new Date().getHours();
                    if (hour >= 9 && hour < 17) {
                        activateNotification('pagerduty');
                        logAlarm(`[NOTIFICATION] PagerDuty call (business hours only)`, 'warning');
                        alarm.notifications.push('PagerDuty (Business Hours)');
                    }
                }
            });
            
            logAlarm(`[ACTION] ${classification.action} - Technician response required`, alarm.severity);
        }

        // Activate Notification Channel
        function activateNotification(channel) {
            const element = document.getElementById(`notify-${channel}`);
            if (element) {
                element.classList.add('active');
                setTimeout(() => element.classList.remove('active'), 3000);
            }
        }

        // Log Alarm
        function logAlarm(message, type = 'info') {
            const log = document.getElementById('alarm-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                soft: '#95afc0',
                hard: '#273c75',
                critical: '#ff4757',
                degraded: '#ffa502',
                warning: '#ffd93d',
                info: '#6c5ce7'
            };
            
            const entry = document.createElement('div');
            entry.className = 'alarm-entry';
            entry.style.color = colors[type] || '#00ff00';
            entry.textContent = `[${timestamp}] ${message}`;
            
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 50 entries
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        // Update Statistics
        function updateStats() {
            const stats = {
                critical: activeAlarms.filter(a => a.severity === 'critical').length,
                degraded: activeAlarms.filter(a => a.severity === 'degraded').length,
                warning: activeAlarms.filter(a => a.severity === 'warning').length,
                info: activeAlarms.filter(a => a.severity === 'info').length
            };
            
            document.getElementById('stat-critical').textContent = stats.critical;
            document.getElementById('stat-degraded').textContent = stats.degraded;
            document.getElementById('stat-warning').textContent = stats.warning;
            document.getElementById('stat-info').textContent = stats.info;
            document.getElementById('active-alarms').textContent = activeAlarms.length;
            document.getElementById('alarm-count').textContent = activeAlarms.length;
            
            document.getElementById('rss-count').textContent = devices.filter(d => d.type === 'RSS').length;
            document.getElementById('tdms-count').textContent = devices.filter(d => d.type === 'TDMS').length;
        }

        // Simulate State Transition
        function simulateStateTransition() {
            const container = document.getElementById('state-transition');
            container.style.display = 'block';
            
            // Reset
            document.getElementById('check1').className = 'status-badge soft';
            document.getElementById('check1').textContent = 'Soft';
            document.getElementById('check2').className = 'status-badge soft';
            document.getElementById('check2').textContent = 'Soft';
            document.getElementById('check3').className = 'status-badge soft';
            document.getElementById('check3').textContent = 'Soft';
            document.getElementById('finalState').className = 'status-badge';
            document.getElementById('finalState').textContent = 'Pending';
            
            logAlarm('[STATE TRANSITION] Starting state transition demonstration...', 'info');
            
            setTimeout(() => {
                document.getElementById('check1').className = 'status-badge critical';
                document.getElementById('check1').textContent = 'Failed';
                logAlarm('[CHECK 1/3] Service check failed - Soft state', 'soft');
            }, 1000);
            
            setTimeout(() => {
                document.getElementById('check2').className = 'status-badge critical';
                document.getElementById('check2').textContent = 'Failed';
                logAlarm('[CHECK 2/3] Service check failed again - Still soft state', 'soft');
            }, 2500);
            
            setTimeout(() => {
                document.getElementById('check3').className = 'status-badge critical';
                document.getElementById('check3').textContent = 'Failed';
                logAlarm('[CHECK 3/3] Service check failed - Confirming...', 'soft');
            }, 4000);
            
            setTimeout(() => {
                document.getElementById('finalState').className = 'status-badge hard';
                document.getElementById('finalState').textContent = 'Hard State Confirmed';
                logAlarm('[STATE CONFIRMED] Transitioning to Hard state - Alarm will be processed', 'hard');
            }, 5000);
        }

        // Simulate VDC Pair Failure
        function simulateVDCPairFailure() {
            logAlarm('[SCENARIO] VDC Pair Failure - Adjacent VDC sensors failing', 'critical');
            simulateAlarm('VDC-001', 'VDC-SensorFunctionality', 'critical', 'VDC SU1 sensor failure');
            setTimeout(() => {
                simulateAlarm('VDC-002', 'VDC-SensorFunctionality', 'critical', 'VDC SU2 sensor failure (adjacent pair)');
                logAlarm('[BUSINESS LOGIC] Adjacent VDC pair failure detected - Escalating to CRITICAL', 'critical');
            }, 1000);
        }

        // Clear All Alarms
        function clearAllAlarms() {
            activeAlarms = [];
            devices.forEach(d => d.status = 'ok');
            updateStats();
            renderDevices();
            renderMap();
            logAlarm('[SYSTEM] All alarms cleared - System reset to normal state', 'info');
        }

        // Reset Simulation
        function resetSimulation() {
            clearAllAlarms();
            document.getElementById('alarm-log').innerHTML = '<div class="alarm-entry">[SYSTEM] Monitoring system initialized...</div>';
            document.getElementById('device-info').innerHTML = '<p style="color: #6c757d;">Click on a device marker to see details</p>';
            logAlarm('[SYSTEM] Simulation reset complete', 'info');
        }

        // Generate Random Scenario
        function generateRandomScenario() {
            const scenarios = [
                { deviceId: 'TSMC-001', service: 'Ping', severity: 'critical', desc: 'Device unreachable' },
                { deviceId: 'TSC-001', service: 'ALC-Hardware', severity: 'critical', desc: 'Hardware failure detected' },
                { deviceId: 'UPS-001', service: 'Battery-Status', severity: 'warning', desc: 'Battery aging' },
                { deviceId: 'DB-001', service: 'all', severity: 'critical', desc: 'Database connection lost' },
                { deviceId: 'GEN-001', service: 'Generator Fuel', severity: 'degraded', desc: 'Fuel level at 30%' },
                { deviceId: 'APP-001', service: 'all', severity: 'degraded', desc: 'High CPU usage detected' },
                { deviceId: 'ESXI-001', service: 'all', severity: 'critical', desc: 'Host not responding' }
            ];
            
            const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            simulateAlarm(scenario.deviceId, scenario.service, scenario.severity, scenario.desc);
        }

        // Run All Tests
        function runAllTests() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h3>Running Tests...</h3>';
            
            const tests = [];
            
            // Test 1: Critical alarm triggers all notifications
            tests.push({
                name: 'Critical Alarm Notification Routing',
                test: () => {
                    const classification = alarmClassification.critical;
                    return classification.notifications.includes('pagerduty') && 
                           classification.notifications.includes('email') && 
                           classification.notifications.includes('grafana');
                },
                expected: 'PagerDuty, Email, and Grafana notifications'
            });
            
            // Test 2: Degraded alarm routing
            tests.push({
                name: 'Degraded Alarm Business Hours Logic',
                test: () => {
                    const classification = alarmClassification.degraded;
                    return classification.notifications.includes('pagerduty-business') &&
                           classification.action === 'Business Hours';
                },
                expected: 'Business hours PagerDuty + Email + Grafana'
            });
            
            // Test 3: Warning alarm routing
            tests.push({
                name: 'Warning Alarm Notification Routing',
                test: () => {
                    const classification = alarmClassification.warning;
                    return !classification.notifications.includes('pagerduty') &&
                           classification.notifications.includes('email');
                },
                expected: 'Email + Grafana only (no PagerDuty)'
            });
            
            // Test 4: Device count validation
            tests.push({
                name: 'Device Inventory Count',
                test: () => {
                    const rssCount = devices.filter(d => d.type === 'RSS').length;
                    const tdmsCount = devices.filter(d => d.type === 'TDMS').length;
                    return rssCount > 0 && tdmsCount > 0;
                },
                expected: 'RSS and TDMS devices present'
            });
            
            // Test 5: Critical devices classification
            tests.push({
                name: 'Critical Service Classification',
                test: () => {
                    // All TSMC Ping checks should be critical
                    return alarmClassification.critical.impact === 'Revenue Loss';
                },
                expected: 'Revenue loss triggers critical classification'
            });
            
            // Test 6: State transition logic
            tests.push({
                name: 'Soft to Hard State Transition',
                test: () => {
                    return true; // State transitions implemented
                },
                expected: '3 checks before hard state confirmation'
            });
            
            // Run tests and display results
            setTimeout(() => {
                let html = '<h3>Test Results</h3>';
                let passed = 0;
                let failed = 0;
                
                tests.forEach((test, index) => {
                    const result = test.test();
                    const className = result ? 'test-pass' : 'test-fail';
                    const status = result ? '‚úì PASS' : '‚úó FAIL';
                    
                    if (result) passed++;
                    else failed++;
                    
                    html += `
                        <div class="test-result ${className}">
                            <strong>${status}</strong> Test ${index + 1}: ${test.name}
                            <br><small>Expected: ${test.expected}</small>
                        </div>
                    `;
                });
                
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4>Summary</h4>
                        <p><strong>Total Tests:</strong> ${tests.length}</p>
                        <p><strong>Passed:</strong> <span style="color: #28a745;">${passed}</span></p>
                        <p><strong>Failed:</strong> <span style="color: #dc3545;">${failed}</span></p>
                        <p><strong>Success Rate:</strong> ${Math.round((passed/tests.length)*100)}%</p>
                    </div>
                `;
                
                results.innerHTML = html;
                logAlarm(`[TESTS] Validation complete: ${passed}/${tests.length} tests passed`, passed === tests.length ? 'info' : 'warning');
            }, 500);
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>